import torch

def count_parameters(model):
    n_params_trainable =  sum(p.numel() for p in model.parameters() if p.requires_grad)
    n_params = sum(p.numel() for p in model.parameters())
    print(f'The model has {n_params} total parameters')
    print(f'The model has {n_params_trainable} trainable parameters')


def print_top_k_classes(preds, k):
    return sorted(preds.items(), key=lambda x: x[1])[::-1][:k]


def adjust_pos_embed(x, pos_embed):
    pos_len = pos_embed.shape[1]
    x_len = x.shape[1]
    dim = pos_embed.shape[-1]  
    new_pos_embed = torch.ones(1, x_len, dim).to(pos_embed.get_device())
    diff = abs(pos_len - x_len)

    if pos_len > x_len:
        new_pos_embed = pos_embed[:, diff:, :]
    elif pos_len < x_len:
        line = pos_embed[0][:1, :]
        lines = line.repeat(diff, 1).unsqueeze(0)
        new_pos_embed[:, :diff, :] = lines
        new_pos_embed[:, diff:, :] = pos_embed
    else:
        new_pos_embed = pos_embed

    return torch.nn.Parameter(new_pos_embed)

def prompt_forward_features(model, x, prompt_ids):

    x = x.float()
    x_embed = model.patch_embed(x)

    out = {}
    batch_size = x.shape[0]

    prompts = model.prompt.prompt
    selected_prompts = prompts[prompt_ids]

    n_selected, length, dim = selected_prompts.shape

    selected_prompts = selected_prompts.unsqueeze(0).repeat(batch_size, 1, 1, 1)
    selected_prompts = selected_prompts.reshape(batch_size, n_selected*length, dim)
    out["total_prompt_len"] = selected_prompts.shape[1]
    model.total_prompt_len = out["total_prompt_len"]
    x = torch.cat([selected_prompts, x_embed], dim=1)
    x = torch.cat((model.cls_token.expand(x.shape[0], -1, -1), x), dim=1)
    model.pos_embed = adjust_pos_embed(x, model.pos_embed)
    x = model.pos_drop(x + model.pos_embed)
    x = model.blocks(x)
    x = model.norm(x)
    out["x"] = x
    return out

def prompt_forward(model, x, prompt_ids):
    res = prompt_forward_features(model, x, prompt_ids)
    res = model.forward_head(res)
    return res


key_class_counts = {0: {0: 500, 1: 500, 2: 500, 3: 500, 4: 500, 5: 500, 6: 500, 7: 500, 8: 500, 9: 500, 10: 500, 11: 500, 12: 500, 13: 500, 14: 500, 15: 500, 16: 500, 17: 500, 18: 500, 19: 500, 20: 500, 21: 500, 22: 500, 23: 500, 24: 500, 25: 500, 26: 500, 27: 500, 28: 500, 29: 500, 30: 500, 31: 500, 32: 500, 33: 500, 34: 500, 35: 500, 36: 500, 37: 500, 38: 500, 39: 500, 40: 500, 41: 500, 42: 500, 43: 500, 44: 500, 45: 500, 46: 500, 47: 500, 48: 500, 49: 500, 50: 500, 51: 500, 52: 500, 53: 500, 54: 500, 55: 500, 56: 500, 57: 500, 58: 500, 59: 500, 60: 500, 61: 500, 62: 500, 63: 500, 64: 500, 65: 500, 66: 500, 67: 500, 68: 500, 69: 500, 70: 500, 71: 500, 72: 500, 73: 500, 74: 500, 75: 500, 76: 500, 77: 500, 78: 500, 79: 500, 80: 500, 81: 500, 82: 500, 83: 500, 84: 500, 85: 500, 86: 500, 87: 500, 88: 500, 89: 500, 90: 500, 91: 500, 92: 500, 93: 500, 94: 500, 95: 500, 96: 500, 97: 500, 98: 500, 99: 500}, 1: {0: 1, 1: 438, 2: 15, 3: 446, 4: 481, 5: 1, 6: 117, 7: 274, 8: 6, 9: 0, 10: 6, 11: 9, 12: 15, 13: 3, 14: 117, 15: 318, 16: 1, 17: 6, 18: 170, 19: 157, 20: 1, 21: 369, 22: 1, 23: 134, 24: 322, 25: 5, 26: 317, 27: 485, 28: 1, 29: 400, 30: 494, 31: 249, 32: 326, 33: 100, 34: 483, 35: 5, 36: 351, 37: 8, 38: 468, 39: 4, 40: 7, 41: 6, 42: 454, 43: 465, 44: 421, 45: 241, 46: 15, 47: 12, 48: 3, 49: 119, 50: 444, 51: 122, 52: 6, 53: 1, 54: 8, 55: 473, 56: 21, 57: 15, 58: 1, 59: 39, 60: 110, 61: 5, 62: 21, 63: 454, 64: 447, 65: 339, 66: 430, 67: 449, 68: 9, 69: 118, 70: 6, 71: 179, 72: 482, 73: 475, 74: 482, 75: 429, 76: 11, 77: 267, 78: 303, 79: 240, 80: 330, 81: 0, 82: 12, 83: 8, 84: 3, 85: 44, 86: 0, 87: 1, 88: 438, 89: 16, 90: 18, 91: 458, 92: 8, 93: 473, 94: 0, 95: 484, 96: 85, 97: 493, 98: 7, 99: 141}, 2: {0: 1, 1: 438, 2: 15, 3: 446, 4: 481, 5: 1, 6: 117, 7: 275, 8: 6, 9: 0, 10: 6, 11: 9, 12: 15, 13: 3, 14: 117, 15: 317, 16: 1, 17: 6, 18: 171, 19: 157, 20: 1, 21: 369, 22: 1, 23: 134, 24: 322, 25: 5, 26: 317, 27: 485, 28: 1, 29: 399, 30: 494, 31: 249, 32: 326, 33: 100, 34: 483, 35: 5, 36: 350, 37: 8, 38: 468, 39: 4, 40: 7, 41: 6, 42: 454, 43: 465, 44: 421, 45: 241, 46: 15, 47: 12, 48: 3, 49: 119, 50: 444, 51: 122, 52: 6, 53: 1, 54: 8, 55: 473, 56: 21, 57: 15, 58: 1, 59: 39, 60: 110, 61: 5, 62: 21, 63: 454, 64: 447, 65: 339, 66: 430, 67: 449, 68: 9, 69: 118, 70: 6, 71: 179, 72: 482, 73: 475, 74: 482, 75: 429, 76: 10, 77: 267, 78: 302, 79: 241, 80: 330, 81: 0, 82: 12, 83: 8, 84: 3, 85: 44, 86: 0, 87: 1, 88: 438, 89: 16, 90: 18, 91: 458, 92: 8, 93: 473, 94: 0, 95: 484, 96: 85, 97: 493, 98: 7, 99: 139}, 3: {0: 1, 1: 438, 2: 15, 3: 446, 4: 481, 5: 1, 6: 117, 7: 274, 8: 6, 9: 0, 10: 6, 11: 9, 12: 15, 13: 3, 14: 117, 15: 318, 16: 1, 17: 6, 18: 170, 19: 157, 20: 1, 21: 369, 22: 1, 23: 134, 24: 322, 25: 5, 26: 317, 27: 484, 28: 1, 29: 400, 30: 494, 31: 249, 32: 326, 33: 100, 34: 483, 35: 5, 36: 351, 37: 8, 38: 468, 39: 4, 40: 7, 41: 6, 42: 454, 43: 465, 44: 421, 45: 241, 46: 15, 47: 12, 48: 3, 49: 119, 50: 444, 51: 122, 52: 6, 53: 1, 54: 8, 55: 473, 56: 21, 57: 15, 58: 1, 59: 39, 60: 110, 61: 5, 62: 21, 63: 454, 64: 447, 65: 339, 66: 430, 67: 449, 68: 9, 69: 118, 70: 6, 71: 179, 72: 482, 73: 475, 74: 482, 75: 429, 76: 11, 77: 267, 78: 303, 79: 240, 80: 330, 81: 0, 82: 12, 83: 8, 84: 3, 85: 44, 86: 0, 87: 1, 88: 438, 89: 16, 90: 18, 91: 458, 92: 8, 93: 473, 94: 0, 95: 484, 96: 85, 97: 493, 98: 7, 99: 142}, 4: {0: 499, 1: 62, 2: 485, 3: 54, 4: 19, 5: 499, 6: 383, 7: 226, 8: 494, 9: 500, 10: 494, 11: 491, 12: 485, 13: 497, 14: 383, 15: 182, 16: 499, 17: 494, 18: 329, 19: 343, 20: 499, 21: 131, 22: 499, 23: 366, 24: 178, 25: 495, 26: 183, 27: 15, 28: 499, 29: 100, 30: 6, 31: 251, 32: 174, 33: 400, 34: 17, 35: 495, 36: 149, 37: 492, 38: 32, 39: 496, 40: 493, 41: 494, 42: 46, 43: 35, 44: 79, 45: 259, 46: 485, 47: 488, 48: 497, 49: 381, 50: 56, 51: 378, 52: 494, 53: 499, 54: 492, 55: 27, 56: 479, 57: 485, 58: 499, 59: 461, 60: 390, 61: 495, 62: 479, 63: 46, 64: 53, 65: 161, 66: 70, 67: 51, 68: 491, 69: 382, 70: 494, 71: 321, 72: 18, 73: 25, 74: 18, 75: 71, 76: 489, 77: 233, 78: 197, 79: 260, 80: 170, 81: 500, 82: 488, 83: 492, 84: 497, 85: 456, 86: 500, 87: 499, 88: 62, 89: 484, 90: 482, 91: 42, 92: 492, 93: 27, 94: 500, 95: 16, 96: 415, 97: 7, 98: 493, 99: 358}, 5: {0: 499, 1: 62, 2: 485, 3: 54, 4: 19, 5: 499, 6: 383, 7: 225, 8: 494, 9: 500, 10: 494, 11: 491, 12: 485, 13: 497, 14: 383, 15: 183, 16: 499, 17: 494, 18: 330, 19: 343, 20: 499, 21: 131, 22: 499, 23: 366, 24: 178, 25: 495, 26: 183, 27: 15, 28: 499, 29: 101, 30: 6, 31: 251, 32: 174, 33: 400, 34: 17, 35: 495, 36: 150, 37: 492, 38: 32, 39: 496, 40: 493, 41: 494, 42: 46, 43: 35, 44: 79, 45: 259, 46: 485, 47: 488, 48: 497, 49: 381, 50: 56, 51: 378, 52: 494, 53: 499, 54: 492, 55: 27, 56: 479, 57: 485, 58: 499, 59: 461, 60: 390, 61: 495, 62: 479, 63: 46, 64: 53, 65: 161, 66: 70, 67: 51, 68: 491, 69: 382, 70: 494, 71: 321, 72: 18, 73: 25, 74: 18, 75: 71, 76: 490, 77: 233, 78: 198, 79: 259, 80: 170, 81: 500, 82: 488, 83: 492, 84: 497, 85: 456, 86: 500, 87: 499, 88: 62, 89: 484, 90: 482, 91: 42, 92: 492, 93: 27, 94: 500, 95: 16, 96: 415, 97: 7, 98: 493, 99: 361}, 6: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0, 25: 0, 26: 0, 27: 0, 28: 0, 29: 0, 30: 0, 31: 0, 32: 0, 33: 0, 34: 0, 35: 0, 36: 0, 37: 0, 38: 0, 39: 0, 40: 0, 41: 0, 42: 0, 43: 0, 44: 0, 45: 0, 46: 0, 47: 0, 48: 0, 49: 0, 50: 0, 51: 0, 52: 0, 53: 0, 54: 0, 55: 0, 56: 0, 57: 0, 58: 0, 59: 0, 60: 0, 61: 0, 62: 0, 63: 0, 64: 0, 65: 0, 66: 0, 67: 0, 68: 0, 69: 0, 70: 0, 71: 0, 72: 0, 73: 0, 74: 0, 75: 0, 76: 0, 77: 0, 78: 0, 79: 0, 80: 0, 81: 0, 82: 0, 83: 0, 84: 0, 85: 0, 86: 0, 87: 0, 88: 0, 89: 0, 90: 0, 91: 0, 92: 0, 93: 0, 94: 0, 95: 0, 96: 0, 97: 0, 98: 0, 99: 0}, 7: {0: 499, 1: 62, 2: 485, 3: 54, 4: 19, 5: 499, 6: 383, 7: 226, 8: 494, 9: 500, 10: 494, 11: 491, 12: 485, 13: 497, 14: 383, 15: 183, 16: 499, 17: 494, 18: 330, 19: 343, 20: 499, 21: 131, 22: 499, 23: 366, 24: 178, 25: 495, 26: 183, 27: 16, 28: 499, 29: 101, 30: 6, 31: 251, 32: 174, 33: 400, 34: 17, 35: 495, 36: 150, 37: 492, 38: 32, 39: 496, 40: 493, 41: 494, 42: 46, 43: 35, 44: 79, 45: 259, 46: 485, 47: 488, 48: 497, 49: 381, 50: 56, 51: 378, 52: 494, 53: 499, 54: 492, 55: 27, 56: 479, 57: 485, 58: 499, 59: 461, 60: 390, 61: 495, 62: 479, 63: 46, 64: 53, 65: 161, 66: 70, 67: 51, 68: 491, 69: 382, 70: 494, 71: 321, 72: 18, 73: 25, 74: 18, 75: 71, 76: 490, 77: 233, 78: 198, 79: 259, 80: 170, 81: 500, 82: 488, 83: 492, 84: 497, 85: 456, 86: 500, 87: 499, 88: 62, 89: 484, 90: 482, 91: 42, 92: 492, 93: 27, 94: 500, 95: 16, 96: 415, 97: 7, 98: 493, 99: 361}, 8: {0: 1, 1: 438, 2: 15, 3: 446, 4: 481, 5: 1, 6: 117, 7: 274, 8: 6, 9: 0, 10: 6, 11: 9, 12: 15, 13: 3, 14: 117, 15: 317, 16: 1, 17: 6, 18: 170, 19: 157, 20: 1, 21: 369, 22: 1, 23: 134, 24: 322, 25: 5, 26: 317, 27: 485, 28: 1, 29: 399, 30: 494, 31: 249, 32: 326, 33: 100, 34: 483, 35: 5, 36: 350, 37: 8, 38: 468, 39: 4, 40: 7, 41: 6, 42: 454, 43: 465, 44: 421, 45: 241, 46: 15, 47: 12, 48: 3, 49: 119, 50: 444, 51: 122, 52: 6, 53: 1, 54: 8, 55: 473, 56: 21, 57: 15, 58: 1, 59: 39, 60: 110, 61: 5, 62: 21, 63: 454, 64: 447, 65: 339, 66: 430, 67: 449, 68: 9, 69: 118, 70: 6, 71: 179, 72: 482, 73: 475, 74: 482, 75: 429, 76: 10, 77: 267, 78: 302, 79: 241, 80: 330, 81: 0, 82: 12, 83: 8, 84: 3, 85: 44, 86: 0, 87: 1, 88: 438, 89: 16, 90: 18, 91: 458, 92: 8, 93: 473, 94: 0, 95: 484, 96: 85, 97: 493, 98: 7, 99: 139}, 9: {0: 499, 1: 62, 2: 485, 3: 54, 4: 19, 5: 499, 6: 383, 7: 226, 8: 494, 9: 500, 10: 494, 11: 491, 12: 485, 13: 497, 14: 383, 15: 182, 16: 499, 17: 494, 18: 330, 19: 343, 20: 499, 21: 131, 22: 499, 23: 366, 24: 178, 25: 495, 26: 183, 27: 15, 28: 499, 29: 100, 30: 6, 31: 251, 32: 174, 33: 400, 34: 17, 35: 495, 36: 149, 37: 492, 38: 32, 39: 496, 40: 493, 41: 494, 42: 46, 43: 35, 44: 79, 45: 259, 46: 485, 47: 488, 48: 497, 49: 381, 50: 56, 51: 378, 52: 494, 53: 499, 54: 492, 55: 27, 56: 479, 57: 485, 58: 499, 59: 461, 60: 390, 61: 495, 62: 479, 63: 46, 64: 53, 65: 161, 66: 70, 67: 51, 68: 491, 69: 382, 70: 494, 71: 321, 72: 18, 73: 25, 74: 18, 75: 71, 76: 489, 77: 233, 78: 197, 79: 260, 80: 170, 81: 500, 82: 488, 83: 492, 84: 497, 85: 456, 86: 500, 87: 499, 88: 62, 89: 484, 90: 482, 91: 42, 92: 492, 93: 27, 94: 500, 95: 16, 96: 415, 97: 7, 98: 493, 99: 359}}
key_task_counts = {0: {0: 5000, 1: 5000, 2: 5000, 3: 5000, 4: 5000, 5: 5000, 6: 5000, 7: 5000, 8: 5000, 9: 5000}, 1: {0: 1779, 1: 802, 2: 2035, 3: 2488, 4: 1743, 5: 1130, 6: 2382, 7: 2874, 8: 852, 9: 2167}, 2: {0: 1780, 1: 802, 2: 2034, 3: 2487, 4: 1743, 5: 1130, 6: 2382, 7: 2873, 8: 852, 9: 2165}, 3: {0: 1779, 1: 802, 2: 2034, 3: 2488, 4: 1743, 5: 1130, 6: 2382, 7: 2874, 8: 852, 9: 2168}, 4: {0: 3221, 1: 4197, 2: 2965, 3: 2512, 4: 3257, 5: 3870, 6: 2618, 7: 2126, 8: 4148, 9: 2832}, 5: {0: 3220, 1: 4199, 2: 2966, 3: 2513, 4: 3257, 5: 3870, 6: 2618, 7: 2127, 8: 4148, 9: 2835}, 6: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0}, 7: {0: 3221, 1: 4199, 2: 2967, 3: 2513, 4: 3257, 5: 3870, 6: 2618, 7: 2127, 8: 4148, 9: 2835}, 8: {0: 1779, 1: 801, 2: 2034, 3: 2487, 4: 1743, 5: 1130, 6: 2382, 7: 2873, 8: 852, 9: 2165}, 9: {0: 3221, 1: 4198, 2: 2965, 3: 2512, 4: 3257, 5: 3870, 6: 2618, 7: 2126, 8: 4148, 9: 2833}}
